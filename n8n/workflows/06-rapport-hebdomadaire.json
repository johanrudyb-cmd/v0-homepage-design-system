[
    {
        "name": "ðŸ“Š OUTFITY - Rapport Hebdomadaire (Resend Optimized)",
        "nodes": [
            {
                "parameters": {
                    "rule": {
                        "interval": [
                            {
                                "field": "cronExpression",
                                "expression": "0 9 * * 1"
                            }
                        ]
                    }
                },
                "id": "cron-weekly",
                "name": "Lundi 9h",
                "type": "n8n-nodes-base.scheduleTrigger",
                "typeVersion": 1.2,
                "position": [
                    240,
                    300
                ]
            },
            {
                "parameters": {
                    "method": "GET",
                    "url": "={{ $env.OUTFITY_APP_URL || 'https://outfity.fr' }}/api/n8n/weekly-stats",
                    "sendHeaders": true,
                    "headerParameters": {
                        "parameters": [
                            {
                                "name": "Authorization",
                                "value": "=Bearer {{ $env.OUTFITY_CRON_SECRET || 'bb22261869ad2d5d33ee928260aa8511125172498917d380bb70f545bfc7d1d6' }}"
                            }
                        ]
                    },
                    "options": {
                        "timeout": 30000
                    }
                },
                "id": "get-stats",
                "name": "RÃ©cupÃ©rer Stats",
                "type": "n8n-nodes-base.httpRequest",
                "typeVersion": 4.2,
                "position": [
                    460,
                    300
                ]
            },
            {
                "parameters": {
                    "jsCode": "const stats = $input.first().json;\n\nconst weekStart = new Date();\nweekStart.setDate(weekStart.getDate() - 7);\n\nreturn [{\n  json: {\n    period: `${weekStart.toLocaleDateString('fr-FR')} - ${new Date().toLocaleDateString('fr-FR')}`,\n    users: {\n      total: stats.totalUsers || 0,\n      new: stats.newUsers || 0,\n      active: stats.activeUsers || 0\n    },\n    trends: {\n      scraped: stats.trendsScraped || 0,\n      confirmed: stats.trendsConfirmed || 0\n    },\n    designs: {\n      created: stats.designsCreated || 0,\n      techPacks: stats.techPacks || 0\n    },\n    revenue: {\n      total: stats.revenue || 0,\n      subscriptions: stats.newSubscriptions || 0\n    },\n    ai: {\n      requests: stats.aiRequests || 0,\n      cost: stats.aiCost || 0\n    }\n  }\n}];"
                },
                "id": "format-report",
                "name": "Formater Rapport",
                "type": "n8n-nodes-base.code",
                "typeVersion": 2,
                "position": [
                    680,
                    300
                ]
            },
            {
                "parameters": {
                    "method": "POST",
                    "url": "https://api.resend.com/emails",
                    "authentication": "genericCredentialType",
                    "genericAuthType": "httpHeaderAuth",
                    "sendHeaders": true,
                    "headerParameters": {
                        "parameters": [
                            {
                                "name": "Authorization",
                                "value": "=Bearer {{ $env.RESEND_API_KEY || 're_HxzF3dkH_LAvcMEzP6Tmfs7HUbXpseuRb' }}"
                            }
                        ]
                    },
                    "sendBody": true,
                    "bodyParameters": {
                        "parameters": [
                            {
                                "name": "from",
                                "value": "OUTFITY Intelligence <contact@outfity.fr>"
                            },
                            {
                                "name": "to",
                                "value": "contact@outfity.fr"
                            },
                            {
                                "name": "subject",
                                "value": "=ðŸ“Š OUTFITY Weekly â€” {{ $json.period }}"
                            },
                            {
                                "name": "html",
                                "value": "=<div style=\"font-family: -apple-system, Inter, sans-serif; max-width: 600px; margin: 0 auto; background: #000; padding: 40px 20px;\">\n  <div style=\"background: white; border-radius: 32px; padding: 48px;\">\n    <h1 style=\"color: #1D1D1F; font-size: 24px; font-weight: 700; text-align: center; letter-spacing: -0.04em;\">Performance Hebdomadaire</h1>\n    <p style=\"color: #86868B; text-align: center; margin-bottom: 32px;\">{{ $json.period }}</p>\n\n    <div style=\"background: #F5F5F7; border-radius: 24px; padding: 24px; margin-bottom: 12px;\">\n      <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n        <span style=\"color: #86868B;\">Nouveaux Utilisateurs</span>\n        <strong style=\"color: #1D1D1F; font-size: 20px;\">+{{ $json.users.new }}</strong>\n      </div>\n    </div>\n\n    <div style=\"background: #F5F5F7; border-radius: 24px; padding: 24px; margin-bottom: 12px;\">\n      <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n        <span style=\"color: #86868B;\">MRR EstimÃ©</span>\n        <strong style=\"color: #34C759; font-size: 20px;\">{{ $json.revenue.total }}â‚¬</strong>\n      </div>\n    </div>\n\n    <div style=\"background: #F5F5F7; border-radius: 24px; padding: 24px; margin-bottom: 12px;\">\n      <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n        <span style=\"color: #86868B;\">Tendances Radar</span>\n        <strong style=\"color: #1D1D1F; font-size: 20px;\">{{ $json.trends.scraped }}</strong>\n      </div>\n    </div>\n\n    <div style=\"background: #F5F5F7; border-radius: 24px; padding: 24px; margin-bottom: 32px;\">\n      <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n        <span style=\"color: #86868B;\">CoÃ»t IA</span>\n        <strong style=\"color: #FF3B30; font-size: 20px;\">{{ $json.ai.cost }}â‚¬</strong>\n      </div>\n    </div>\n\n    <a href=\"{{ $env.OUTFITY_APP_URL || 'https://outfity.fr' }}/dashboard\" style=\"display: block; width: 100%; padding: 18px 0; background: #000; color: #fff; text-align: center; border-radius: 100px; text-decoration: none; font-weight: 600;\">VÃ©rifier sur OUTFITY</a>\n  </div>\n</div>"
                            }
                        ]
                    },
                    "options": {}
                },
                "id": "send-report",
                "name": "Resend - Rapport Admin",
                "type": "n8n-nodes-base.httpRequest",
                "typeVersion": 4.1,
                "position": [
                    900,
                    300
                ]
            }
        ],
        "connections": {
            "cron-weekly": {
                "main": [
                    [
                        {
                            "node": "get-stats",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "get-stats": {
                "main": [
                    [
                        {
                            "node": "format-report",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "format-report": {
                "main": [
                    [
                        {
                            "node": "send-report",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            }
        },
        "settings": {
            "executionOrder": "v1"
        }
    }
]