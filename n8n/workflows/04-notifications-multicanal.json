[
    {
        "name": "üîî OUTFITY - Notifications Multi-Canal (Resend Optimized)",
        "nodes": [
            {
                "parameters": {
                    "httpMethod": "POST",
                    "path": "outfity-notify",
                    "responseMode": "responseNode",
                    "options": {}
                },
                "id": "webhook-notify",
                "name": "Webhook Notification",
                "type": "n8n-nodes-base.webhook",
                "typeVersion": 2,
                "position": [
                    240,
                    300
                ],
                "webhookId": "outfity-notify"
            },
            {
                "parameters": {
                    "jsCode": "const { userId, email, name, eventType, data } = $input.first().json;\n\nconst eventTemplates = {\n  'trend_alert': {\n    subject: 'üìà Nouvelle tendance d√©tect√©e !',\n    title: 'Tendance Mode D√©tect√©e',\n    body: `Une nouvelle tendance a √©t√© identifi√©e : ${data?.trendName || 'Nouveau style'}`,\n    cta: 'Voir les tendances',\n    ctaUrl: '/trends'\n  },\n  'design_ready': {\n    subject: 'üé® Votre Tech Pack est pr√™t !',\n    title: 'Tech Pack Termin√©',\n    body: `Votre tech pack \"${data?.designName || 'Design'}\" est pr√™t √† t√©l√©charger.`,\n    cta: 'Voir mon Tech Pack',\n    ctaUrl: `/designs/${data?.designId || ''}`\n  },\n  'factory_match': {\n    subject: 'üè≠ Nouveau match usine trouv√© !',\n    title: 'Match Usine',\n    body: `Nous avons trouv√© ${data?.count || 1} usine(s) correspondant √† votre recherche.`,\n    cta: 'Voir les usines',\n    ctaUrl: '/sourcing'\n  },\n  'payment_success': {\n    subject: '‚úÖ Paiement confirm√©',\n    title: 'Paiement Accept√©',\n    body: `Votre paiement de ${data?.amount || '0'}‚Ç¨ a √©t√© accept√©. Votre plan ${data?.plan || 'Pro'} est actif.`,\n    cta: 'Voir mon compte',\n    ctaUrl: '/settings'\n  }\n};\n\nconst template = eventTemplates[eventType] || {\n  subject: 'üîî Notification OUTFITY',\n  title: 'Notification',\n  body: data?.message || 'Vous avez une nouvelle notification.',\n  cta: 'Voir sur OUTFITY',\n  ctaUrl: '/dashboard'\n};\n\nreturn [{\n  json: {\n    userId, email, name: name || 'Cr√©ateur',\n    eventType, template, data\n  }\n}];"
                },
                "id": "build-template",
                "name": "Construire Template",
                "type": "n8n-nodes-base.code",
                "typeVersion": 2,
                "position": [
                    460,
                    300
                ]
            },
            {
                "parameters": {
                    "respondWith": "json",
                    "responseBody": "={ \"success\": true }",
                    "options": {
                        "responseCode": 200
                    }
                },
                "id": "respond-ok",
                "name": "R√©ponse OK",
                "type": "n8n-nodes-base.respondToWebhook",
                "typeVersion": 1,
                "position": [
                    680,
                    180
                ]
            },
            {
                "parameters": {
                    "method": "POST",
                    "url": "={{ $env.OUTFITY_APP_URL || 'https://outfity.fr' }}/api/notifications",
                    "sendHeaders": true,
                    "headerParameters": {
                        "parameters": [
                            {
                                "name": "Authorization",
                                "value": "=Bearer {{ $env.OUTFITY_CRON_SECRET || 'bb22261869ad2d5d33ee928260aa8511125172498917d380bb70f545bfc7d1d6' }}"
                            }
                        ]
                    },
                    "sendBody": true,
                    "bodyParameters": {
                        "parameters": [
                            {
                                "name": "userId",
                                "value": "={{ $json.userId }}"
                            },
                            {
                                "name": "type",
                                "value": "={{ $json.eventType }}"
                            },
                            {
                                "name": "title",
                                "value": "={{ $json.template.title }}"
                            },
                            {
                                "name": "message",
                                "value": "={{ $json.template.body }}"
                            }
                        ]
                    }
                },
                "id": "create-notification",
                "name": "Notif In-App",
                "type": "n8n-nodes-base.httpRequest",
                "typeVersion": 4.2,
                "position": [
                    680,
                    300
                ]
            },
            {
                "parameters": {
                    "method": "POST",
                    "url": "https://api.resend.com/emails",
                    "authentication": "genericCredentialType",
                    "genericAuthType": "httpHeaderAuth",
                    "sendHeaders": true,
                    "headerParameters": {
                        "parameters": [
                            {
                                "name": "Authorization",
                                "value": "=Bearer {{ $env.RESEND_API_KEY || 're_HxzF3dkH_LAvcMEzP6Tmfs7HUbXpseuRb' }}"
                            }
                        ]
                    },
                    "sendBody": true,
                    "bodyParameters": {
                        "parameters": [
                            {
                                "name": "from",
                                "value": "OUTFITY <onboarding@outfity.fr>"
                            },
                            {
                                "name": "to",
                                "value": "={{ $json.email }}"
                            },
                            {
                                "name": "subject",
                                "value": "={{ $json.template.subject }}"
                            },
                            {
                                "name": "html",
                                "value": "=<div style=\"font-family: -apple-system, Inter, sans-serif; max-width: 600px; margin: 0 auto; background: #F5F5F7; padding: 40px 20px;\">\n  <div style=\"background: white; border-radius: 32px; padding: 48px; text-align: center;\">\n    <h1 style=\"color: #1D1D1F; font-size: 24px; font-weight: 700; letter-spacing: -0.04em; margin-bottom: 20px;\">{{ $json.template.title }}</h1>\n    <p style=\"color: #1D1D1F; font-size: 16px; line-height: 1.6;\">Bonjour {{ $json.name }},</p>\n    <p style=\"color: #1D1D1F; font-size: 16px; line-height: 1.6; margin-bottom: 32px;\">{{ $json.template.body }}</p>\n    <a href=\"{{ $env.OUTFITY_APP_URL || 'https://outfity.fr' }}{{ $json.template.ctaUrl }}\" style=\"display: inline-block; background: #000; color: #fff; padding: 18px 36px; border-radius: 100px; text-decoration: none; font-weight: 600;\">{{ $json.template.cta }} ‚Üí</a>\n    <p style=\"color: #86868B; font-size: 12px; margin-top: 40px;\">OUTFITY par BIANGORY</p>\n  </div>\n</div>"
                            }
                        ]
                    },
                    "options": {}
                },
                "id": "send-email",
                "name": "Resend - Notification",
                "type": "n8n-nodes-base.httpRequest",
                "typeVersion": 4.1,
                "position": [
                    900,
                    300
                ]
            }
        ],
        "connections": {
            "Webhook Notification": {
                "main": [
                    [
                        {
                            "node": "build-template",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "build-template": {
                "main": [
                    [
                        {
                            "node": "respond-ok",
                            "type": "main",
                            "index": 0
                        },
                        {
                            "node": "create-notification",
                            "type": "main",
                            "index": 0
                        },
                        {
                            "node": "send-email",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            }
        },
        "settings": {
            "executionOrder": "v1"
        }
    }
]