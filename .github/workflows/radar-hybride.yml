name: ðŸ•µï¸ OUTFITY - Radar Hybride Automatique

on:
  schedule:
    # Tous les mardis Ã  12:00 UTC (13h ou 14h en France selon l'heure d'Ã©tÃ©/hiver)
    - cron: '0 12 * * 2'
  workflow_dispatch: # Permet de lancer le scrape manuellement depuis l'interface GitHub

jobs:
  scrape-trends:
    runs-on: ubuntu-latest
    timeout-minutes: 30 # Large marge pour Puppeteer

    steps:
      - name: ðŸ“¥ RÃ©cupÃ©ration du code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Configuration de Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Installation des dÃ©pendances
        run: npm install

      - name: ðŸŒ Installation de Puppeteer & Chrome
        run: npx puppeteer browsers install chrome

      - name: ðŸš€ Lancement du Scrape Radar Hybride
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ADMIN_NOTIFY_WEBHOOK_URL: ${{ secrets.ADMIN_NOTIFY_WEBHOOK_URL }}
          # On peut rajouter d'autres clÃ©s si besoin
        run: |
          npx tsx -e "
            import { refreshAllTrends } from './lib/refresh-all-trends';
            import { enrichTrends } from './lib/trend-enricher';
            import { notifyAdmin } from './lib/admin-notifications';

            async function runFullProcess() {
              console.log('--- DEBUT DU RADAR HYBRIDE ---');
              
              // 1. Scraping
              const scrapeResult = await refreshAllTrends();
              console.log('Scrape terminÃ©:', scrapeResult.savedCount, 'produits sauvÃ©s');

              // 2. Enrichissement
              console.log('DÃ©but enrichissement IA...');
              const enrichResult = await enrichTrends(10);
              console.log('Enrichissement terminÃ©:', enrichResult.enriched, 'produits analysÃ©s');

              // 3. Notification
              await notifyAdmin({
                type: 'scrape_success',
                title: 'ðŸ•µï¸ Radar Hebdomadaire (GitHub Actions)',
                message: 'Le Radar de mardi midi a bien fonctionnÃ©. ' + scrapeResult.savedCount + ' nouveaux produits dÃ©tectÃ©s.',
                emoji: 'ðŸ•µï¸',
                data: { scrapeResult, enrichResult }
              });
              
              console.log('--- PROCESSUS TERMINE ---');
            }

            runFullProcess().catch(err => {
              console.error('Erreur Critique:', err);
              process.exit(1);
            });
          "
