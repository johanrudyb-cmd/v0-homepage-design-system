name: üïµÔ∏è OUTFITY - Radar Hybride Automatique

on:
  schedule:
    # Tous les mardis √† 12:00 UTC (13h ou 14h en France selon l'heure d'√©t√©/hiver)
    - cron: '0 12 * * 2'
  workflow_dispatch: # Permet de lancer le scrape manuellement depuis l'interface GitHub

jobs:
  scrape-trends:
    runs-on: ubuntu-latest
    timeout-minutes: 60 # Augment√© √† 60 minutes car 27 sources c'est long

    steps:
      - name: üì• R√©cup√©ration du code
        uses: actions/checkout@v4

      - name: üü¢ Configuration de Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Installation des d√©pendances (via cache)
        run: npm ci || npm install

      - name: üåê Installation de Puppeteer & Chrome
        run: npx puppeteer browsers install chrome

      - name: üöÄ Lancement du Scrape Radar Hybride
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ADMIN_NOTIFY_WEBHOOK_URL: ${{ secrets.ADMIN_NOTIFY_WEBHOOK_URL }}
        run: |
          npx tsx -e "
            import { refreshAllTrends } from './lib/refresh-all-trends';
            import { enrichTrends } from './lib/trend-enricher';
            import { notifyAdmin } from './lib/admin-notifications';

            async function runFullProcess() {
              console.log('üöÄ D√©marrage du Radar Hybride pour OUTFITY (v2026)');
              const start = Date.now();
              
              // 1. Scraping
              console.log('--- ETAPE 1 : SCRAPING EN COURS ---');
              const scrapeResult = await refreshAllTrends();
              console.log('‚úÖ Scrape fini en ' + ((Date.now() - start)/1000).toFixed(0) + 's');
              console.log('üìä Stats : ' + scrapeResult.savedCount + ' produits enregistr√©s.');

              // 2. Enrichissement
              console.log('--- ETAPE 2 : ENRICHISSEMENT IA ---');
              const enrichResult = await enrichTrends(12);
              console.log('‚úÖ IA finie. Produits analys√©s : ' + enrichResult.enriched);

              // 3. Notification
              console.log('--- ETAPE 3 : NOTIFICATION ---');
              await notifyAdmin({
                type: 'scrape_success',
                title: 'üïµÔ∏è Radar OUTFITY Termin√©',
                message: 'Le Radar a bien moulin√©. ' + scrapeResult.savedCount + ' produits trouv√©s, ' + enrichResult.enriched + ' enrichis.',
                emoji: 'ÔøΩ',
                data: { 
                  total: scrapeResult.totalItems,
                  saved: scrapeResult.savedCount,
                  enriched: enrichResult.enriched,
                  duration: ((Date.now() - start)/60000).toFixed(1) + ' min'
                }
              });
              
              console.log('‚ú® Tout est en base de donn√©es. Mission accomplie.');
            }

            runFullProcess().catch(err => {
              console.error('‚ùå ERREUR CRITIQUE:', err);
              process.exit(1);
            });
          "
