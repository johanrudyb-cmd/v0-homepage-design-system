// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  password      String?   // Pour auth email/password
  plan            String    @default("free") // free, pro, enterprise
  
  // Relations Clean (Retour aux bases)
  referredByCode  String?   // Code du parrain (Optionnel, on peut le garder sans risque)
  
  subscribedAt    DateTime? 
  stripeCustomerId String?   @unique
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts        Account[]
  sessions        Session[]
  brands          Brand[]
  notifications   Notification[]
  factoryReviews  FactoryReview[]
  preferences     UserPreferences?
  fashionBrands   FashionBrand[]
  aiUsages        AIUsage[]
  surplusCredits  SurplusCredits[]
  posts           BlogPost[]
  affiliateProfile AffiliateProfile?
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============== CORE BUSINESS ==============

model Brand {
  id        String   @id @default(cuid())
  userId    String
  name      String
  
  // Identit√© de marque
  logo              String?
  logoVariations    Json?
  colorPalette      Json?
  typography        Json?
  styleGuide        Json?
  domain            String?
  socialHandles     Json?
  templateBrandSlug String?
  
  creationMode      String   @default("quick")
  autoApplyIdentity Boolean  @default(true)
  status            String   @default("draft")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user                 User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  designs              Design[]
  collections          Collection[]
  launchMap            LaunchMap?
  launchMapDesignDrafts LaunchMapDesignDraft[]
  ugcContents          UGCContent[]
  mannequins           Mannequin[]
  strategyGenerations  StrategyGeneration[]
  favoriteFactories    BrandFavoriteFactory[]
  mockShopifyProducts  MockShopifyProduct[]

  @@index([userId])
}

model Design {
  id          String   @id @default(cuid())
  brandId     String
  collectionId String?
  isTemplate  Boolean  @default(false)
  templateName String?
  type        String
  cut         String?
  material    String?
  flatSketchUrl String?
  productImageUrl String?
  mockupSpec  Json?
  techPack    Json?
  productDescription String?  @db.Text
  prompt      String?
  status      String   @default("pending")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  brand      Brand       @relation(fields: [brandId], references: [id], onDelete: Cascade)
  collection Collection? @relation(fields: [collectionId], references: [id], onDelete: SetNull)

  @@index([brandId])
  @@index([collectionId])
  @@index([isTemplate, brandId])
  @@index([type])
  @@index([status])
}

model Collection {
  id          String   @id @default(cuid())
  brandId     String
  name        String
  description String?
  coverImage  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  brand    Brand             @relation(fields: [brandId], references: [id], onDelete: Cascade)
  designs  Design[]
  articles CollectionArticle[]

  @@index([brandId])
}

model CollectionArticle {
  id           String   @id @default(cuid())
  collectionId String
  type         String   
  label        String?
  sortOrder    Int      @default(0)
  payload      Json     
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@index([collectionId])
}

model LaunchMap {
  id        String   @id @default(cuid())
  brandId   String   @unique
  phase1    Boolean  @default(false)
  phase2    Boolean  @default(false)
  phase3    Boolean  @default(false)
  phase4    Boolean  @default(false)
  phase5    Boolean  @default(false)
  phase6    Boolean  @default(false)
  phase7    Boolean  @default(false)
  shopifyShopDomain String?
  phase1Data Json?
  baseMockupByProductType Json?
  phaseSummaries Json?
  recommendationsCache    Json?
  recommendationsCachedAt DateTime?
  contentCalendar         Json?
  siteCreationTodo        Json?
  shopifyAccessToken      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)
}

model MockShopifyProduct {
  id          String   @id @default(cuid())
  brandId     String
  shopifyId   String   @unique
  title       String
  description String   @db.Text
  vendor      String
  type        String
  price       Float
  imageUrl    String?  @db.Text
  status      String   @default("draft")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  brand       Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
}

model LaunchMapDesignDraft {
  id        String   @id @default(cuid())
  brandId   String
  imageUrl  String   @db.Text
  placement String?
  source    String?
  createdAt DateTime @default(now())

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@index([brandId, createdAt])
}

model Mannequin {
  id        String   @id @default(cuid())
  brandId   String
  name      String
  imageUrl  String   @db.Text
  source    String   @default("virtual_tryon")
  gender    String   @default("female")
  description String? @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
}

model StrategyGeneration {
  id                 String   @id @default(cuid())
  brandId            String
  templateBrandSlug  String
  templateBrandName  String
  strategyText       String   @db.Text
  positioning        String?
  targetAudience     String?
  visualIdentity     Json?
  createdAt          DateTime @default(now())

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@index([brandId, createdAt])
}

model TemplateStrategy {
  id                 String   @id @default(cuid())
  templateBrandSlug  String   @unique
  templateBrandName  String
  strategyText       String   @db.Text
  visualIdentity     Json?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([templateBrandSlug])
}

model Factory {
  id          String   @id @default(cuid())
  name        String
  country     String
  moq         Int
  specialties String[]
  leadTime    Int
  certifications String[]
  contactEmail String?
  contactPhone String?
  website     String?
  rating      Float?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  quotes            Quote[]
  reviews           FactoryReview[]
  favoriteByBrands  BrandFavoriteFactory[]

  @@index([country])
  @@index([specialties])
}

model BrandFavoriteFactory {
  id         String   @id @default(cuid())
  brandId    String
  factoryId  String
  createdAt  DateTime @default(now())

  brand   Brand   @relation(fields: [brandId], references: [id], onDelete: Cascade)
  factory Factory @relation(fields: [factoryId], references: [id], onDelete: Cascade)

  @@unique([brandId, factoryId])
  @@index([brandId])
  @@index([factoryId])
}

model Quote {
  id        String   @id @default(cuid())
  brandId   String
  factoryId String
  designId  String?
  status    String   @default("pending")
  message   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  factory Factory @relation(fields: [factoryId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@index([factoryId])
}

model FactoryReview {
  id        String   @id @default(cuid())
  userId    String
  factoryId String
  rating    Int
  comment   String?  @db.Text
  photos    String[]
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  factory Factory @relation(fields: [factoryId], references: [id], onDelete: Cascade)

  @@unique([userId, factoryId])
  @@index([factoryId])
  @@index([userId])
}

model SurplusCredits {
  id               String   @id @default(cuid())
  userId           String
  feature          String
  amount           Int
  consumed         Int      @default(0)
  stripeSessionId  String?  @unique
  packId           String?
  createdAt        DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, feature])
}

model AIUsage {
  id        String   @id @default(cuid())
  userId    String
  feature   String
  costEur   Float
  metadata  Json?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([userId])
}

model UGCContent {
  id        String   @id @default(cuid())
  brandId   String
  type      String
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
}

// ============== TRENDS & ANALYSIS ==============

model BrandSpyAnalysis {
  id          String   @id @default(cuid())
  userId      String
  shopifyUrl  String
  storeName   String?
  category    String?
  launchDate  String?
  country     String?
  
  estimatedRevenue        Float?
  estimatedDailyRevenue   Float?
  estimatedMonthlyRevenue  Float?
  productCount            Int?
  averageOrdersPerMonth   Int?
  
  trafficSources          Json?
  markets                 Json?
  monthlyTraffic          Json?
  monthlyRevenue          Json?
  
  stack       Json?
  theme       Json?
  
  adStrategy  Json?
  adsEvolution Json?
  adTypes     Json?
  
  aiAnalysis  Json?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model BrandAnalysis {
  id              String   @id @default(cuid())
  brandKey        String   @unique
  brandName       String
  analysis        String   @db.Text
  visualIdentity  Json?
  logoUrl         String?
  
  signaturePiece  String?
  dominantStyle   String?
  cyclePhase      String?
  launchPotential String?
  indicativePrice String?
  websiteUrl      String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([brandKey])
}

model FashionBrand {
  id              String   @id @default(cuid())
  userId          String
  name            String
  url             String
  isTrackingActive Boolean @default(false)
  lastSales24h    Int      @default(0)
  lastRevenue24h  Float    @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user       User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  snapshots  StoreSnapshot[]

  @@unique([userId, url])
  @@index([userId])
  @@index([isTrackingActive])
}

model StoreSnapshot {
  id            String   @id @default(cuid())
  brandId       String
  timestamp     DateTime @default(now())
  inventoryData Json
  salesDiff     Int      @default(0)
  revenueDiff   Float    @default(0)
  createdAt     DateTime @default(now())

  brand FashionBrand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId, timestamp])
  @@index([brandId])
}

model TrendingBrand {
  id              String   @id @default(cuid())
  rank            Int
  brand           String
  score           String
  scoreValue      Int
  signaturePiece  String
  dominantStyle   String
  cyclePhase      String
  launchPotential String
  indicativePrice String
  websiteUrl      String?
  month           String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([rank, month])
  @@index([month])
}

model TrendProduct {
  id            String   @id @default(cuid())
  name          String
  category      String
  style         String
  material      String
  averagePrice  Float
  trendScore    Float
  saturability  Float
  imageUrl      String?
  description   String?  @db.Text
  searchVolume  Int?
  marketZone    String?
  cut           String?
  visualTags    Json?
  trendScoreVisual Float?
  productSignature String?
  isGlobalTrendAlert Boolean @default(false)
  sourceBrand   String?
  productBrand  String?
  sourceUrl     String?
  brandWebsiteUrl String?
  segment       String?
  trendGrowthPercent Int?
  trendLabel    String?
  businessAnalysis String? @db.Text
  color         String?
  sizes         String?
  countryOfOrigin String?
  articleNumber String?
  careInstructions String? @db.Text
  daysInTop10   Int?
  estimatedCogsPercent Float?
  complexityScore String?
  sustainabilityScore Float?
  stockOutRisk  String?
  markdownPercent Float?
  visualAttractivenessScore Float?
  dominantAttribute String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  favorites ProductFavorite[]

  @@index([marketZone])
  @@index([segment])
  @@index([productSignature])
  @@index([isGlobalTrendAlert])
}

model ProductFavorite {
  id        String   @id @default(cuid())
  userId   String
  productId String
  createdAt DateTime @default(now())

  product TrendProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
}

model TrendSignal {
  id                String   @id @default(cuid())
  productName       String
  productType       String
  cut               String?
  material          String?
  color             String?
  brand             String
  sourceUrl         String
  sourceSection     String
  country           String?
  style             String?
  price             Float
  priceCurrency     String   @default("EUR")
  imageUrl          String?
  appearanceCount   Int      @default(1)
  firstSeenAt       DateTime @default(now())
  lastSeenAt        DateTime @default(now())
  confirmedAt       DateTime?
  isConfirmed       Boolean   @default(false)
  confirmationScore Int       @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([productType, isConfirmed])
  @@index([brand, sourceSection])
  @@index([confirmedAt])
  @@index([isConfirmed, confirmationScore])
  @@index([country])
  @@index([style])
  @@index([country, style])
}

model GeneratedProductImage {
  id         String   @id @default(cuid())
  trendKey   String   @unique
  promptText String   @db.Text
  imageUrl   String   @db.Text
  adviceText String?  @db.Text
  rating     Int?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([trendKey])
}

model ScrapableBrand {
  id              String   @id @default(cuid())
  name            String   @unique
  baseUrl         String
  newInUrl        String
  bestSellersUrl  String
  productSelector String
  nameSelector    String
  priceSelector   String
  imageSelector   String
  isActive        Boolean  @default(true)
  country         String?
  category        String?
  priority        Int      @default(5)
  notes           String?  @db.Text
  lastScrapedAt   DateTime?
  lastScrapeSuccess Boolean @default(true)
  totalScraped    Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ============== SYSTEME DE BLOG (VITAL) ==============

model BlogPost {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  excerpt     String   @db.Text
  content     String   @db.Text
  coverImage  String?
  sourceUrl   String?
  tags        String[]
  relatedBrands String[]
  published   Boolean  @default(false)
  publishedAt DateTime @default(now())
  authorId    String
  categoryId  String?
  
  seoTitle       String?
  seoDescription String?
  seoKeywords    String?

  author    User     @relation(fields: [authorId], references: [id])
  category  BlogCategory? @relation(fields: [categoryId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([published])
  @@index([slug])
}

model BlogCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  
  posts       BlogPost[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String   @db.Text
  type      String   @default("info")
  read      Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([userId, createdAt])
}

model UserPreferences {
  id        String   @id @default(cuid())
  userId    String   @unique
  preferredCountry String?
  preferredCountries String[]
  preferredCategories String[]
  preferredStyles     String[]
  priceRangeMin       Float?
  priceRangeMax       Float?
  preferredSourcingCountries String[]
  preferredMOQ              Int?
  maxLeadTime               Int?
  preferredMarkets          String[]
  language                  String   @default("fr")
  currency                  String   @default("EUR")
  timezone                  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
}

model AdminLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  details   Json?
  status    String   @default("success") // success, error
  metadata  Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([action])
  @@index([userId])
  @@index([createdAt])
}

model AffiliateProfile {
  id           String   @id @default(cuid())
  userId       String   @unique
  referralCode String   @unique
  earnings     Float    @default(0)
  clicks       Int      @default(0)
  conversions  Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([referralCode])
}
